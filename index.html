<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Gymingå·±é…©å¥èº«æ—¥å¿—</title>
  <link rel="apple-touch-icon" href="icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { background-color: #f9fafb; }
    input[type="text"], input[type="number"], textarea {
        background-color: transparent;
        outline: none;
    }
    .day-duration {
        position: absolute;
        bottom: 2px;
        right: 2px;
        font-size: 8px;
        color: #fff;
        background-color: rgba(0, 0, 0, 0.4);
        padding: 0 2px;
        border-radius: 4px;
        line-height: 1;
        font-weight: bold;
        z-index: 10;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import ReactDOM from 'react-dom/client';
    import { 
      Calendar as CalendarIcon, Dumbbell, BookOpen, TrendingUp, ChevronLeft, ChevronRight, 
      Plus, X, Info, Clock, Play, Pause, RotateCcw, CheckCircle2, Circle, ArrowLeft, 
      GripVertical, Music, Layers, CheckSquare, Timer, Feather, Download, Upload, FileJson,
      FolderHeart, Save, Trash2
    } from 'lucide-react';

    // --- å…¨æ–°å‡çº§ï¼šæ··åˆæ¶æ„é˜²å˜å½¢è¶‹åŠ¿å›¾ ---
    const TrendChart = ({ data, labels, color = "#3b82f6", label = "æ•°æ®" }) => {
      const cleanData = data.map((d, i) => ({ val: Number(d), label: labels[i] }))
                            .filter(item => !isNaN(item.val) && item.val !== 0 && item.val !== null);

      if (cleanData.length < 2) return (
        <div className="h-40 flex flex-col items-center justify-center bg-gray-50 rounded-xl border border-dashed border-gray-200 text-gray-400 text-xs">
           <TrendingUp className="w-6 h-6 mb-1 opacity-20"/>
           <span>è®°å½•è‡³å°‘ 2 å¤©æ•°æ®ä»¥ç”Ÿæˆè¶‹åŠ¿çº¿</span>
        </div>
      );

      const values = cleanData.map(d => d.val);
      const max = Math.max(...values);
      const min = Math.min(...values);
      const range = max - min || 1;
      // å¢åŠ  10% çš„ä¸Šä¸‹è¾¹è·ï¼Œé˜²æ­¢ç‚¹è´´ç€è¾¹ç¼˜
      const padding = range * 0.1;
      const displayMin = min - padding;
      const displayRange = (max + padding) - displayMin;

      // ç”Ÿæˆ SVG è·¯å¾„åæ ‡ (0-100)
      const points = cleanData.map((d, i) => {
        const x = (i / (cleanData.length - 1)) * 100;
        const y = 100 - ((d.val - displayMin) / displayRange) * 100;
        return `${x},${y}`;
      }).join(' ');

      const areaPoints = `${points} 100,100 0,100`;

      return (
        <div className="w-full bg-white p-4 pt-6 rounded-xl shadow-sm border border-gray-100 mb-6">
            <div className="flex justify-between items-center mb-6">
                <h3 className="font-bold text-gray-700">{label}</h3>
                <span className="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-500">æœ€è¿‘ {cleanData.length} æ¬¡</span>
            </div>
            
            <div className="relative h-48 w-full">
                {/* 1. èƒŒæ™¯ç½‘æ ¼ */}
                <div className="absolute inset-0 flex flex-col justify-between text-[10px] text-gray-300 pointer-events-none">
                    <div className="border-b border-gray-50 h-full w-full"></div>
                    <div className="border-b border-gray-50 h-full w-full"></div>
                    <div className="border-b border-gray-50 h-full w-full"></div>
                </div>

                {/* 2. SVG çº¿æ¡å±‚ (å…è®¸å˜å½¢æ‹‰ä¼¸) */}
                <svg viewBox="0 0 100 100" preserveAspectRatio="none" className="absolute inset-0 w-full h-full overflow-visible z-0">
                    <defs>
                        <linearGradient id={`grad-${color}`} x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor={color} stopOpacity="0.2" />
                            <stop offset="100%" stopColor={color} stopOpacity="0" />
                        </linearGradient>
                    </defs>
                    <polygon points={areaPoints} fill={`url(#grad-${color})`} />
                    <polyline points={points} fill="none" stroke={color} strokeWidth="2" vectorEffect="non-scaling-stroke" strokeLinecap="round" strokeLinejoin="round" />
                </svg>

                {/* 3. HTML ç‚¹ä¸æ•°æ®å±‚ (ç»å¯¹å®šä½ï¼Œé˜²æ­¢åœ†ç‚¹å˜å½¢) */}
                {cleanData.map((d, i) => {
                    const left = (i / (cleanData.length - 1)) * 100;
                    const bottom = ((d.val - displayMin) / displayRange) * 100;
                    return (
                        <div key={i} className="absolute flex flex-col items-center group" style={{ left: `${left}%`, bottom: `${bottom}%`, transform: 'translate(-50%, 50%)' }}>
                            {/* æ•°å€¼ (é»˜è®¤æ˜¾ç¤º) */}
                            <span className="mb-2 text-[10px] font-bold text-gray-600 bg-white/80 px-1 rounded shadow-sm backdrop-blur-sm transform -translate-y-2">{d.val}</span>
                            {/* åœ†ç‚¹ */}
                            <div className="w-3 h-3 bg-white border-2 rounded-full shadow-sm z-10 transition-transform group-hover:scale-125" style={{ borderColor: color }}></div>
                            {/* æ—¥æœŸ (æ”¾åœ¨åº•éƒ¨ï¼Œé¿å…é®æŒ¡) */}
                            <div className="absolute top-6 text-[9px] text-gray-400 whitespace-nowrap font-medium">{d.label}</div>
                        </div>
                    );
                })}
            </div>
            {/* åº•éƒ¨ç•™ç™½ç»™æ—¥æœŸ */}
            <div className="h-6"></div> 
        </div>
      );
    };

    // --- åˆå§‹æ•°æ® ---
    const INITIAL_EXERCISES = [
        { id: 101, name: 'å“‘é“ƒå§æ¨', part: 'èƒ¸éƒ¨', maxWeight: '30', sets: '4', reps: '8-12', note: '' },
        { id: 102, name: 'å¹³æ¿æ é“ƒçª„è·å§æ¨', part: 'èƒ¸éƒ¨', maxWeight: '60', sets: '4', reps: '8-12', note: 'ä¸è‚©åŒå®½ ä¸‹è½åˆ°ä¸Šè…¹éƒ¨' },
        { id: 103, name: 'çª„è·ä¿¯å§æ’‘', part: 'èƒ¸éƒ¨', maxWeight: '0', sets: '4', reps: 'åŠ›ç«­', note: 'æ ¸å¿ƒæ”¶ç´§' },
        { id: 104, name: 'åå§¿å¤¹èƒ¸', part: 'èƒ¸éƒ¨', maxWeight: '40', sets: '4', reps: '12-15', note: 'é¡¶å³°æ”¶ç¼©' },
        { id: 201, name: 'æ é“ƒåˆ’èˆ¹ / åå§¿åˆ’èˆ¹', part: 'èƒŒéƒ¨', maxWeight: '60', sets: '4', reps: '10', note: 'å§æ¨æ¡è·' },
        { id: 202, name: 'å¯¹æ¡çª„è·é«˜ä½ä¸‹æ‹‰', part: 'èƒŒéƒ¨', maxWeight: '50', sets: '4', reps: '10-12', note: 'è‚©å®½æˆ–çª„ä¸è‚©' },
        { id: 203, name: 'å¯¹æ¡å®½è·é«˜ä½ä¸‹æ‹‰', part: 'èƒŒéƒ¨', maxWeight: '50', sets: '4', reps: '10-12', note: 'å§æ¨æ¡è·æˆ–å®½ä¸è‚©' },
        { id: 204, name: 'ç›´è‡‚ä¸‹å‹', part: 'èƒŒéƒ¨', maxWeight: '25', sets: '4', reps: '15', note: 'æ„Ÿå—èƒŒé˜”è‚Œå‘åŠ›' },
        { id: 301, name: 'å“‘é“ƒææ‹‰ (ä¸­åæŸ)', part: 'è‚©éƒ¨', maxWeight: '15', sets: '4', reps: '12', note: 'é’ˆå¯¹ä¸­åæŸ' },
        { id: 302, name: 'åå‘é£é¸Ÿ (åæŸ)', part: 'è‚©éƒ¨', maxWeight: '10', sets: '4', reps: '15', note: 'é’ˆå¯¹åæŸ' },
        { id: 303, name: 'å“‘é“ƒææ‹‰ (ä¸­æŸ)', part: 'è‚©éƒ¨', maxWeight: '15', sets: '4', reps: '12', note: 'é’ˆå¯¹ä¸­æŸ' },
        { id: 304, name: 'ä¾§å¹³ä¸¾', part: 'è‚©éƒ¨', maxWeight: '10', sets: '6', reps: '15', note: 'å“‘é“ƒä¸è¦è¶…è¿‡è‚©è†€é«˜åº¦' },
        { id: 401, name: 'å“‘é“ƒçª„è·äºŒå¤´å¼¯ä¸¾', part: 'æ‰‹è‡‚', maxWeight: '15', sets: '4', reps: '12', note: 'ğŸ”¥ è¶…çº§ç»„ï¼šå»ºè®®ä¸ä¸‰å¤´é¢ˆåè‡‚å±ˆä¼¸è¿ç€åš' },
        { id: 402, name: 'ä¸‰å¤´é¢ˆåè‡‚å±ˆä¼¸', part: 'æ‰‹è‡‚', maxWeight: '20', sets: '4', reps: '12', note: 'ğŸ”¥ è¶…çº§ç»„ï¼šå»ºè®®ä¸äºŒå¤´å¼¯ä¸¾è¿ç€åš' },
        { id: 403, name: 'å“‘é“ƒå‚å¼å¼¯ä¸¾', part: 'æ‰‹è‡‚', maxWeight: '15', sets: '4', reps: '12', note: 'ğŸ”¥ è¶…çº§ç»„ï¼šå»ºè®®ä¸å¹³æ¿å‡³è‡‚å±ˆä¼¸è¿ç€åš' },
        { id: 404, name: 'å¹³æ¿å‡³åå§¿è‡‚å±ˆä¼¸', part: 'æ‰‹è‡‚', maxWeight: '0', sets: '4', reps: '15', note: 'è…°èƒŒç›´ç«‹è´´ä½å‡³å­ï¼Œç›´ä¸Šç›´ä¸‹ï¼Œä¸‹è½åˆ°å¤§è‡‚è·Ÿåœ°é¢æ°´å¹³ã€‚ğŸ”¥ å»ºè®®ä¸å‚å¼å¼¯ä¸¾è¿ç€åš' },
        { id: 501, name: 'ä¼ ç»Ÿç¡¬æ‹‰', part: 'è…¿éƒ¨', maxWeight: '100', sets: '5', reps: '5', note: '' },
        { id: 502, name: 'è´Ÿé‡ç®­æ­¥è¹²', part: 'è…¿éƒ¨', maxWeight: '20', sets: '4', reps: '12', note: 'ç®­æ­¥è¹²ç«™è·ï¼šä¸€æ¬¡ä¸€ä¸ªè„šæŒï¼Œä¸‹ä¸€æ¬¡ç»ƒè…¿ä¸¤ä¸ªè„šæŒï¼Œäº¤æ›¿åšã€‚è†ç›–ä¸è¦å†…æ‰£' },
        { id: 503, name: 'åå§¿æˆ–ä¿¯èº«è…¿å¼¯ä¸¾', part: 'è…¿éƒ¨', maxWeight: '35', sets: '4', reps: '12', note: '' },
        { id: 504, name: 'åå§¿è…¿å±ˆä¼¸', part: 'è…¿éƒ¨', maxWeight: '40', sets: '4', reps: '12', note: '' },
        { id: 601, name: 'æ³¢æ¯”è·³ (Burpee)', part: 'å¤åˆå‹', maxWeight: '0', sets: '4', reps: '15', note: 'å…¨èº«ç‡ƒè„‚' },
        { id: 701, name: 'ç»³ç´¢é¢æ‹‰ (Face Pull)', part: 'ä½“æ€çº æ­£', maxWeight: '15', sets: '4', reps: '15', note: 'æ”¹å–„åœ†è‚©' },
    ];
    
    // --- åˆå§‹æ—¥å¿— ---
    const INITIAL_LOGS = {
        '2025-11-25': { status: 'trained', title: 'åˆå§‹è®°å½•', weight: 74.5, cardio: 0, duration: 1.0, exercises: [] },
        '2025-11-26': { status: 'trained', title: 'æ¢å¤è®­ç»ƒ', weight: 74.0, cardio: 30, duration: 1.0, exercises: [] },
        '2025-11-27': { status: 'rest', title: 'ä¼‘æ¯æ—¥', weight: 73.8, cardio: 0, duration: 0, exercises: [] },
        '2025-11-28': { status: 'trained', title: 'èƒ¸éƒ¨è®­ç»ƒ', weight: 73.5, cardio: 20, duration: 1.5, exercises: [{ id: 101, name: 'å“‘é“ƒå§æ¨', sets: '4', reps: '8', weight: '30', completed: true }] }
    };

    function App() {
      const [activeTab, setActiveTab] = useState('calendar'); 
      const [exercises, setExercises] = useState(() => { try { return JSON.parse(localStorage.getItem('ironlog_exercises')) || INITIAL_EXERCISES; } catch (e) { return INITIAL_EXERCISES; } });
      const [logs, setLogs] = useState(() => { try { return JSON.parse(localStorage.getItem('ironlog_logs')) || INITIAL_LOGS; } catch (e) { return INITIAL_LOGS; } });
      const [routines, setRoutines] = useState(() => { try { return JSON.parse(localStorage.getItem('ironlog_routines')) || []; } catch (e) { return []; } });
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const [selectedForSession, setSelectedForSession] = useState([]);
      const [showTimer, setShowTimer] = useState(false);
      const [timerRunning, setTimerRunning] = useState(false);
      const [timeLeft, setTimeLeft] = useState(60); 
      const [totalTime, setTotalTime] = useState(60); 
      const [newExName, setNewExName] = useState('');
      const [newExPart, setNewExPart] = useState('èƒ¸éƒ¨'); 
      const [newExMaxWeight, setNewExMaxWeight] = useState('');
      const [newExSets, setNewExSets] = useState('4');
      const [newExReps, setNewExReps] = useState('12');
      const [newExNote, setNewExNote] = useState('');
      const [showAddForm, setShowAddForm] = useState(false);
      const fileInputRef = useRef(null);

      useEffect(() => { localStorage.setItem('ironlog_exercises', JSON.stringify(exercises)); }, [exercises]);
      useEffect(() => { localStorage.setItem('ironlog_logs', JSON.stringify(logs)); }, [logs]);
      useEffect(() => { localStorage.setItem('ironlog_routines', JSON.stringify(routines)); }, [routines]);

      useEffect(() => {
        let interval = null;
        if (timerRunning && timeLeft > 0) { interval = setInterval(() => setTimeLeft((t) => t - 1), 1000); } 
        else if (timeLeft === 0 && timerRunning) { setTimerRunning(false); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); }
        return () => clearInterval(interval);
      }, [timerRunning, timeLeft]);

      const handleTimePreset = (newTime) => { setTotalTime(newTime); setTimeLeft(newTime); setTimerRunning(false); };
      const getDaysInMonth = (date) => ({ daysInMonth: new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate(), firstDay: new Date(date.getFullYear(), date.getMonth(), 1).getDay() });
      const formatDateKey = (date) => date.toISOString().split('T')[0];
      const dateKey = formatDateKey(selectedDate);
      const currentLog = logs[dateKey] || { status: 'none', title: '', weight: '', cardio: '', duration: '', exercises: [] };
      const updateLog = (field, value) => { setLogs(prev => ({ ...prev, [dateKey]: { ...currentLog, [field]: value } })); };
      const toggleStatus = (targetStatus) => { updateLog('status', currentLog.status === targetStatus ? 'none' : targetStatus); };

      const commitSelectionToDay = () => {
        if (selectedForSession.length === 0) return;
        const newExs = selectedForSession.map(id => {
          const master = exercises.find(e => e.id === id);
          if (!master) return null;
          return { id: master.id, name: master.name, sets: master.sets, reps: master.reps, weight: master.maxWeight, completed: false };
        }).filter(Boolean);
        updateLog('exercises', [...(currentLog.exercises || []), ...newExs]);
        if (currentLog.status !== 'trained') updateLog('status', 'trained');
        setSelectedForSession([]);
        setActiveTab('calendar');
      };

      const toggleSelection = (exId) => {
        if (selectedForSession.includes(exId)) setSelectedForSession(prev => prev.filter(id => id !== exId));
        else setSelectedForSession(prev => [...prev, exId]);
      };

      const toggleGroupSelection = (groupList) => {
        const groupIds = groupList.map(ex => ex.id);
        const allSelected = groupIds.every(id => selectedForSession.includes(id));
        setSelectedForSession(prev => allSelected ? prev.filter(id => !groupIds.includes(id)) : [...prev, ...groupIds.filter(id => !prev.includes(id))]);
      };

      // --- ç»„åˆåŠŸèƒ½ ---
      const handleSaveRoutine = () => {
        if (selectedForSession.length === 0) return;
        const name = prompt("ç»™è¿™ä¸ªè®­ç»ƒç»„åˆèµ·ä¸ªåå­— (ä¾‹å¦‚: ä¸‰åˆ†åŒ–-æ¨èƒ¸æ—¥)");
        if (!name) return;
        setRoutines(prev => [...prev, { id: Date.now(), name, exerciseIds: [...selectedForSession] }]);
        alert(`ç»„åˆ "${name}" å·²ä¿å­˜ï¼ä¸‹æ¬¡ç‚¹å‡»å®ƒå³å¯ä¸€é”®é€‰æ‹©ã€‚`);
      };
      const handleLoadRoutine = (routine) => { setSelectedForSession([...new Set([...selectedForSession, ...routine.exerciseIds])]); };
      const handleDeleteRoutine = (e, id) => { e.stopPropagation(); if(confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªç»„åˆå—ï¼Ÿ')) setRoutines(prev => prev.filter(r => r.id !== id)); };
      
      const getGroupedExercises = () => {
        const groups = {};
        exercises.forEach(ex => { if (!groups[ex.part]) groups[ex.part] = []; groups[ex.part].push(ex); });
        return ['èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è…¿éƒ¨', 'å¤åˆå‹', 'ä½“æ€çº æ­£', 'å…¶ä»–'].map(part => ({ part, list: groups[part] || [] })).filter(g => g.list.length > 0);
      };
      const handleAddNewExercise = () => {
        if (!newExName || !newExPart || !newExSets || !newExReps) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼'); return; }
        setExercises(prev => [...prev, { id: Date.now(), name: newExName, part: newExPart, maxWeight: newExMaxWeight || '0', sets: newExSets, reps: newExReps, note: newExNote }]);
        setShowAddForm(false); setNewExName(''); setNewExMaxWeight(''); setNewExNote('');
      };
      const handleDurationChange = (e) => { const value = parseFloat(e.target.value); updateLog('duration', isNaN(value) ? '' : value); }
      const handleDragStart = (e, index) => {}; const handleDragOver = (e, index) => {}; const handleDragEnd = () => {};

      const exportData = () => {
        const blob = new Blob([JSON.stringify({ logs, exercises, routines }, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `gyming_backup_${formatDateKey(new Date())}.json`; a.click(); URL.revokeObjectURL(url);
      };
      const importData = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if (data.logs && data.exercises) {
                    if(confirm(`åŒ…å« ${Object.keys(data.logs).length} æ¡è®°å½•ã€‚è¦†ç›–å½“å‰æ•°æ®ï¼Ÿ`)) {
                        setLogs(data.logs); setExercises(data.exercises); if(data.routines) setRoutines(data.routines); alert('æ¢å¤æˆåŠŸï¼');
                    }
                } else alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
            } catch { alert('è¯»å–å¤±è´¥'); }
        };
        reader.readAsText(file);
      };

      const getChartData = () => {
        const sorted = Object.keys(logs).sort((a, b) => new Date(a) - new Date(b)).slice(-10);
        return { 
          dates: sorted.map(d => d.slice(5)), 
          weights: sorted.map(d => logs[d].weight), 
          cardios: sorted.map(d => logs[d].cardio) 
        };
      };
      const chartData = getChartData();

      return (
        <div className="min-h-screen bg-gray-50 flex justify-center font-sans text-gray-800">
          <div className="w-full max-w-md bg-white h-screen shadow-2xl relative flex flex-col overflow-hidden">
            <div className="bg-gray-900 text-white p-4 pt-8 shrink-0 z-20 shadow-md flex justify-between items-center">
              <div><h1 className="text-xl font-bold flex items-center gap-2"><Dumbbell className="text-red-500" /> Gymingå·±é…©å¥èº«æ—¥å¿—</h1><p className="text-xs text-gray-400">å¡‘é€ æ›´å¼ºçš„è‡ªå·±</p></div>
              <button onClick={() => setShowTimer(!showTimer)} className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold transition-all shadow-lg ${timerRunning ? 'bg-red-500 text-white animate-pulse' : 'bg-gray-800 text-gray-200 border border-gray-700'}`}><Clock className={`w-5 h-5 ${timerRunning ? 'animate-spin' : ''}`} />{timerRunning ? `${timeLeft}s` : 'ä¼‘æ¯'}</button>
            </div>

            {showTimer && (
              <div className="bg-gray-800 text-white p-5 border-b-4 border-red-500 shadow-2xl z-30 fixed top-[80px] w-full max-w-md">
                <div className="flex justify-between items-center mb-6">
                  <div><span className="text-xs text-gray-400 font-bold uppercase">Current Rest</span><div className={`text-5xl font-mono font-black ${timeLeft < 10 ? 'text-red-500' : ''}`}>{Math.floor(timeLeft / 60)}:{Math.floor(timeLeft % 60).toString().padStart(2, '0')}</div></div>
                  <div className="flex gap-3"><button onClick={() => setTimerRunning(!timerRunning)} className={`w-14 h-14 rounded-full flex items-center justify-center ${timerRunning ? 'bg-yellow-500 text-black' : 'bg-emerald-500 text-white'}`}>{timerRunning ? <Pause className="w-6 h-6"/> : <Play className="w-6 h-6 ml-1"/>}</button><button onClick={() => { setTimeLeft(totalTime); setTimerRunning(false); }} className="w-14 h-14 rounded-full bg-gray-700 text-white flex items-center justify-center"><RotateCcw className="w-6 h-6"/></button></div>
                </div>
                <div className="grid grid-cols-2 gap-3 mb-2">{[60, 90, 180, 300].map(sec => <button key={sec} onClick={() => handleTimePreset(sec)} className={`h-12 rounded-xl font-bold ${totalTime === sec ? 'bg-red-500 text-white' : 'bg-gray-700 text-gray-300'}`}>{sec >= 60 ? `${sec/60}m` : `${sec}s`}</button>)}</div>
              </div>
            )}

            <div className="flex-1 overflow-y-auto pb-24 no-scrollbar">
              {activeTab === 'calendar' && (
                <div className="p-4 space-y-6">
                  <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                    <div className="flex justify-between items-center mb-4">
                      <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() - 1)))}><ChevronLeft/></button>
                      <h2 className="font-bold text-lg">{currentMonth.getFullYear()}å¹´ {currentMonth.getMonth() + 1}æœˆ</h2>
                      <button onClick={() => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth() + 1)))}><ChevronRight/></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 text-center mb-2">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d} className="text-xs text-gray-400">{d}</div>)}</div>
                    <div className="grid grid-cols-7 gap-2">
                      {Array(getDaysInMonth(currentMonth).firstDay).fill(null).map((_, i) => <div key={`e-${i}`}/>)}
                      {Array(getDaysInMonth(currentMonth).daysInMonth).fill(null).map((_, i) => {
                        const day = i + 1; const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day); const k = formatDateKey(d); const log = logs[k]; const isSelected = k === dateKey;
                        let cls = "text-gray-700 hover:bg-gray-100";
                        if (log?.status === 'trained') cls = "bg-red-500 text-white shadow-lg shadow-red-200 scale-105 font-bold";
                        else if (log?.status === 'rest') cls = "bg-emerald-400 text-white shadow-lg shadow-emerald-200 scale-105 font-bold";
                        else if (log?.status === 'deload') cls = "bg-orange-400 text-white shadow-lg shadow-orange-200 scale-105 font-bold";
                        return <button key={day} onClick={() => setSelectedDate(d)} className={`aspect-square rounded-full flex items-center justify-center text-sm transition-all relative ${cls} ${isSelected ? 'ring-2 ring-gray-900 ring-offset-2 z-10' : ''}`}>{day}{log?.duration && log.duration > 0 && <span className="day-duration">{log.duration}h</span>}</button>;
                      })}
                    </div>
                  </div>
                  <div className="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden min-h-[400px]">
                    <div className="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
                      <div><span className="text-xs text-gray-400 uppercase tracking-wider">{selectedDate.toLocaleDateString()}</span><input type="text" placeholder="ä»Šæ—¥ä¸»é¢˜" className="block w-full bg-transparent font-bold text-lg outline-none" value={currentLog.title} onChange={(e) => updateLog('title', e.target.value)} /></div>
                      <div className="flex gap-2">
                        <button onClick={() => toggleStatus('trained')} className={`p-3 rounded-xl transition-all ${currentLog.status === 'trained' ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 text-gray-400'}`}><Dumbbell className="w-5 h-5"/></button>
                        <button onClick={() => toggleStatus('rest')} className={`p-3 rounded-xl transition-all ${currentLog.status === 'rest' ? 'bg-emerald-400 text-white shadow-lg' : 'bg-gray-100 text-gray-400'}`}><CalendarIcon className="w-5 h-5"/></button>
                        <button onClick={() => toggleStatus('deload')} className={`p-3 rounded-xl transition-all ${currentLog.status === 'deload' ? 'bg-orange-400 text-white shadow-lg' : 'bg-gray-100 text-gray-400'}`}><Feather className="w-5 h-5"/></button>
                      </div>
                    </div>
                    <div className="p-4 space-y-4">
                      <div className="flex items-center gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100"><div className="bg-blue-200 p-2 rounded-full text-blue-700"><TrendingUp className="w-4 h-4"/></div><div className="flex-1"><label className="text-xs text-blue-600 font-medium">ä½“é‡ (Weight)</label><div className="flex items-baseline gap-1"><input type="number" step="0.1" placeholder="0.0" className="bg-transparent text-xl font-bold text-blue-900 outline-none w-20" value={currentLog.weight} onChange={(e) => updateLog('weight', e.target.value)} /><span className="text-sm text-blue-500">KG</span></div></div></div>
                      <div className="flex items-center gap-3 bg-orange-50 p-3 rounded-xl border border-orange-100"><div className="bg-orange-200 p-2 rounded-full text-orange-700"><Timer className="w-4 h-4"/></div><div className="flex-1"><label className="text-xs text-orange-600 font-medium">ä»Šæ—¥æœ‰æ°§ (Cardio)</label><div className="flex items-baseline gap-1"><input type="number" placeholder="0" className="bg-transparent text-xl font-bold text-orange-900 outline-none w-20" value={currentLog.cardio} onChange={(e) => updateLog('cardio', e.target.value)} /><span className="text-sm text-orange-500">Min</span></div></div></div>
                      <div className="flex items-center gap-3 bg-fuchsia-50 p-3 rounded-xl border border-fuchsia-100"><div className="bg-fuchsia-200 p-2 rounded-full text-fuchsia-700"><Clock className="w-4 h-4"/></div><div className="flex-1"><label className="text-xs text-fuchsia-600 font-medium">æ€»è®­ç»ƒæ—¶é•¿ (Duration)</label><div className="flex items-baseline gap-1"><input type="number" step="0.1" placeholder="0.0" className="bg-transparent text-xl font-bold text-fuchsia-900 outline-none w-20" value={currentLog.duration} onChange={handleDurationChange} /><span className="text-sm text-fuchsia-500">Hrs</span></div></div></div>
                      <div>
                        <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-gray-700">ä»Šæ—¥å®‰æ’</h3><button onClick={() => setActiveTab('library')} className="text-xs flex items-center gap-1 font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100"><Plus className="w-3 h-3"/> æ·»åŠ åŠ¨ä½œ</button></div>
                        {currentLog.exercises && currentLog.exercises.length > 0 ? (
                          <div className="space-y-3">{currentLog.exercises.map((item, index) => (<div key={index} className="bg-white border border-gray-100 rounded-xl p-3 shadow-sm hover:shadow-md transition-all"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-2"><div className="cursor-grab text-gray-300"><GripVertical className="w-4 h-4"/></div><span className="font-bold text-gray-800">{item.name}</span></div><button onClick={() => {const ex = [...currentLog.exercises]; ex.splice(index,1); updateLog('exercises', ex);}} className="text-gray-300 hover:text-red-500"><X className="w-4 h-4"/></button></div><div className="grid grid-cols-3 gap-2 text-sm pl-6">{['sets', 'reps', 'weight'].map(field => (<div key={field} className="bg-gray-50 rounded p-1.5"><span className="text-[10px] text-gray-400 capitalize">{field}</span><input type={field === 'weight' || field === 'reps' ? 'number' : 'text'} step={field === 'weight' ? '0.1' : '1'} className="bg-transparent font-bold w-full outline-none" value={item[field]} onChange={(e) => {const ex = [...currentLog.exercises]; ex[index][field] = e.target.value; updateLog('exercises', ex);}} /></div>))}</div></div>))}</div>
                        ) : <div className="text-center py-8 text-gray-400 text-sm bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>}
                      </div>
                      <textarea placeholder="è®­ç»ƒå¿ƒå¾—..." className="w-full text-sm bg-gray-50 p-3 rounded-xl outline-none h-24 border border-transparent focus:bg-white focus:border-gray-200" />
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'library' && (
                <div className="p-4 pb-32">
                  <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => setActiveTab('calendar')} className="p-2 hover:bg-gray-100 rounded-full"><ArrowLeft className="w-5 h-5 text-gray-600"/></button>
                    <div><h2 className="text-2xl font-bold text-gray-800">åŠ¨ä½œåº“</h2><p className="text-sm text-gray-500">å·²é€‰ {selectedForSession.length} ä¸ªåŠ¨ä½œ</p></div>
                  </div>

                  <div className="mb-6">
                    <h3 className="text-sm font-bold text-gray-500 mb-2 flex items-center gap-1"><FolderHeart className="w-4 h-4"/> æˆ‘çš„è®­ç»ƒé¢„è®¾ (ç‚¹å‡»å³å¯é€‰æ‹©)</h3>
                    <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                      {routines.length === 0 && (
                         <div className="shrink-0 w-48 bg-gray-50 border-2 border-dashed border-indigo-200 rounded-xl p-3 flex flex-col items-center justify-center text-indigo-400 text-xs gap-1">
                            <span className="font-bold">ğŸ‘‡ å¦‚ä½•åˆ›å»ºç»„åˆï¼Ÿ</span>
                            <span>1. åœ¨ä¸‹æ–¹é€‰ä¸­å‡ ä¸ªåŠ¨ä½œ</span>
                            <span>2. åº•éƒ¨ä¼šå‡ºç°â€œå­˜ä¸ºç»„åˆâ€æŒ‰é’®</span>
                         </div>
                      )}
                      {routines.map(routine => (
                        <div key={routine.id} onClick={() => handleLoadRoutine(routine)} className="shrink-0 w-32 bg-indigo-50 border border-indigo-100 rounded-xl p-3 relative hover:shadow-md transition-all cursor-pointer group active:scale-95">
                           <button onClick={(e) => handleDeleteRoutine(e, routine.id)} className="absolute top-1 right-1 text-indigo-300 hover:text-red-500 p-1"><Trash2 className="w-3 h-3"/></button>
                           <div className="font-bold text-indigo-900 text-sm truncate mb-1">{routine.name}</div>
                           <div className="text-[10px] text-indigo-500">{routine.exerciseIds.length} ä¸ªåŠ¨ä½œ</div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <div className={`bg-white p-4 rounded-xl shadow-lg border border-indigo-100 mb-6 ${showAddForm ? 'block' : 'hidden'}`}>
                      <h3 className="font-bold text-indigo-700 mb-3 flex justify-between items-center">æ·»åŠ æ–°åŠ¨ä½œ<button onClick={() => setShowAddForm(false)} className="text-gray-400 hover:text-gray-600"><X className="w-4 h-4"/></button></h3>
                      <div className="space-y-3">
                          <input type="text" placeholder="åŠ¨ä½œåç§°" value={newExName} onChange={(e) => setNewExName(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg text-sm" />
                          <select value={newExPart} onChange={(e) => setNewExPart(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg text-sm">
                              {['èƒ¸éƒ¨', 'èƒŒéƒ¨', 'è‚©éƒ¨', 'æ‰‹è‡‚', 'è…¿éƒ¨', 'å¤åˆå‹', 'ä½“æ€çº æ­£', 'å…¶ä»–'].map(part => <option key={part} value={part}>{part}</option>)}
                          </select>
                          <div className="grid grid-cols-3 gap-2"><input type="text" placeholder="ç»„æ•°" value={newExSets} onChange={(e) => setNewExSets(e.target.value)} className="p-2 border border-gray-200 rounded-lg text-sm" /><input type="text" placeholder="æ¬¡æ•°" value={newExReps} onChange={(e) => setNewExReps(e.target.value)} className="p-2 border border-gray-200 rounded-lg text-sm" /><input type="number" placeholder="é‡é‡" value={newExMaxWeight} onChange={(e) => setNewExMaxWeight(e.target.value)} className="p-2 border border-gray-200 rounded-lg text-sm" /></div>
                          <textarea placeholder="å¤‡æ³¨" value={newExNote} onChange={(e) => setNewExNote(e.target.value)} className="w-full p-2 border border-gray-200 rounded-lg text-sm h-16" />
                          <button onClick={handleAddNewExercise} className="w-full bg-indigo-600 text-white p-2 rounded-lg font-bold hover:bg-indigo-700 transition-colors">+ æ·»åŠ åˆ°æˆ‘çš„åŠ¨ä½œåº“</button>
                      </div>
                  </div>
                  
                  <button onClick={() => setShowAddForm(prev => !prev)} className={`w-full p-3 rounded-xl font-bold text-sm mb-4 transition-colors ${showAddForm ? 'bg-red-500 text-white' : 'bg-indigo-500 text-white hover:bg-indigo-600'}`}>{showAddForm ? 'éšè—æ·»åŠ è¡¨å•' : '+ åˆ›å»ºæ–°åŠ¨ä½œ'}</button>

                  <div className="space-y-6">
                    {getGroupedExercises().map(group => {
                      const groupIds = group.list.map(ex => ex.id);
                      const isAllSelected = groupIds.every(id => selectedForSession.includes(id));
                      return (
                        <div key={group.part}>
                          <div className="flex justify-between items-center mb-3 px-1"><div className="flex items-center gap-2"><div className="w-1 h-5 bg-red-500 rounded-full"/><h3 className="font-bold text-gray-700 text-lg">{group.part}</h3></div><button onClick={() => toggleGroupSelection(group.list)} className={`text-xs px-3 py-1.5 rounded-full font-bold flex gap-1 ${isAllSelected ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-500'}`}>{isAllSelected ? <CheckSquare className="w-3 h-3"/> : <Layers className="w-3 h-3"/>} {isAllSelected ? 'å·²å…¨é€‰' : 'å…¨é€‰'}</button></div>
                          <div className="grid gap-3">
                            {group.list.map(ex => {
                              const isSelected = selectedForSession.includes(ex.id);
                              return (
                                <div key={ex.id} className={`rounded-xl border cursor-pointer p-4 ${isSelected ? 'bg-indigo-50 border-indigo-500' : 'bg-white border-gray-100'}`} onClick={() => toggleSelection(ex.id)}>
                                  <div className="flex items-center justify-between"><div className="flex items-center gap-3"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${isSelected ? 'bg-indigo-500 text-white' : 'bg-gray-100 text-gray-400'}`}>{isSelected ? <CheckCircle2 className="w-6 h-6"/> : ex.name[0]}</div><div><h3 className={`font-bold ${isSelected ? 'text-indigo-900' : 'text-gray-800'}`}>{ex.name}</h3><span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded">{ex.sets}x{ex.reps}</span></div></div>{isSelected ? <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center"><CheckCircle2 className="w-4 h-4 text-white"/></div> : <Circle className="w-6 h-6 text-gray-300"/>}</div>
                                  {ex.note && <div className="mt-2 text-xs text-gray-500">ğŸ’¡ {ex.note}</div>}
                                </div>
                              )
                            })}
                          </div>
                        </div>
                      )
                    })}
                  </div>
                  
                  {selectedForSession.length > 0 && (
                    <div className="fixed bottom-24 left-0 right-0 px-4 z-30 flex gap-2 justify-center">
                        <button onClick={handleSaveRoutine} className="bg-gray-800 text-white shadow-xl px-4 py-4 rounded-full font-bold flex items-center gap-2 transition-transform active:scale-95"><Save className="w-5 h-5"/> <span className="text-xs">å­˜ä¸ºç»„åˆ</span></button>
                        <button onClick={commitSelectionToDay} className="flex-1 max-w-xs bg-indigo-600 text-white shadow-xl px-6 py-4 rounded-full font-bold flex items-center justify-center gap-2 transition-transform active:scale-95">ç¡®è®¤æ·»åŠ  {selectedForSession.length} ä¸ªåŠ¨ä½œ <ChevronRight className="w-5 h-5"/></button>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'stats' && (
                <div className="p-4 space-y-6">
                  <h2 className="text-2xl font-bold text-gray-800">è®­ç»ƒæ´å¯Ÿ</h2>
                  {/* ä½¿ç”¨ TrendChart æ›¿ä»£ SimpleLineChart */}
                  <TrendChart data={chartData.weights} labels={chartData.dates} label="ä½“é‡è¶‹åŠ¿ (Weight)" color="#3b82f6" />
                  <TrendChart data={chartData.cardios} labels={chartData.dates} label="æœ‰æ°§æ—¶é•¿ (Cardio)" color="#f97316" />
                  
                  <div className="bg-gray-800 text-white p-5 rounded-2xl shadow-lg mt-8">
                    <h3 className="font-bold mb-2 flex items-center gap-2"><FileJson className="w-5 h-5"/> æ•°æ®ç®¡ç†</h3><p className="text-xs text-gray-400 mb-4">æ‰‹åŠ¨å¯¼å‡º/å¯¼å…¥æ–‡ä»¶æ¥åŒæ­¥æ•°æ®ã€‚</p>
                    <div className="flex gap-3"><button onClick={exportData} className="flex-1 bg-indigo-500 hover:bg-indigo-600 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2"><Download className="w-4 h-4"/> å¯¼å‡ºå¤‡ä»½</button><button onClick={() => fileInputRef.current.click()} className="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2"><Upload className="w-4 h-4"/> å¯¼å…¥è®°å½•</button><input type="file" ref={fileInputRef} onChange={importData} className="hidden" accept=".json" /></div>
                  </div>
                </div>
              )}
            </div>

            <div className="w-full bg-white border-t border-gray-100 px-6 py-4 flex justify-between items-center z-20 shrink-0">
              <button onClick={() => setActiveTab('calendar')} className={`flex flex-col items-center gap-1 ${activeTab === 'calendar' ? 'text-gray-900' : 'text-gray-400'}`}><CalendarIcon className="w-6 h-6"/><span className="text-[10px] font-medium">æ—¥å†</span></button>
              <button onClick={() => setActiveTab('library')} className={`flex flex-col items-center gap-1 ${activeTab === 'library' ? 'text-gray-900' : 'text-gray-400'}`}><BookOpen className="w-6 h-6"/><span className="text-[10px] font-medium">åŠ¨ä½œåº“</span></button>
              <button onClick={() => setActiveTab('stats')} className={`flex flex-col items-center gap-1 ${activeTab === 'stats' ? 'text-gray-900' : 'text-gray-400'}`}><TrendingUp className="w-6 h-6"/><span className="text-[10px] font-medium">æ´å¯Ÿ</span></button>
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
